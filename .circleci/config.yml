# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  docker: circleci/docker@1.7.0
  
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  cargo-build:
    docker:
      - image: cimg/rust:1.59.0
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: "create artifact folder"
          command: "mkdir /tmp/artifacts"
      - run:
          name: "build"
          command: "cargo build --target-dir /tmp/artifacts"
      - store_artifacts:
          path: /tmp/artifacts/debug/rusted_wumpus
  cargo-build-win:
    docker:
      - image: cimg/rust:1.59.0
    steps:
      - checkout
      - docker/install-docker
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: "create artifact folder"
          command: "mkdir /tmp/artifacts"
      - run:
          name: "install requirements"
          command: "cargo install cross"
      # - run:
      #     name: "add build target"
      #     command: "rustup target add x86_64-pc-windows-gnu"
      # - run:
      #     name: "install toolchain"
      #     command: "rustup toolchain install stable-x86_64-pc-windows-gnu"
      - run:
          name: "build"
          command: "cross build --target x86_64-pc-windows-gnu --target-dir /tmp/artifacts"
      - store_artifacts:
          path: /tmp/artifacts/debug/rusted_wumpus.exe

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  linux:
    jobs:
      - cargo-build
  windows:
    jobs:
      - cargo-build-win
